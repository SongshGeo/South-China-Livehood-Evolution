---
title: 模型工作流
author: Shuang Song
---

典型的多主体模型实验拥有下图所示的结构，左侧是[实验流程]，右侧是[模型流程]。

![workflow](https://songshgeo-picgo-1302043007.cos.ap-beijing.myqcloud.com/uPic/workflow.png)

## 实验流程

在每一次实验中，本库会自动完成以下步骤：

1. 获取不同参数的组合，确定实验配置组数（jobs）
2. 批量运行模型，每次运行(run)都保存运行的结果
3. 绘制所有job的对比结果图（[热力图]、[断点图]、[动态图]）
4. 存储[总结数据]（`summary.csv`）

## 模型流程

在每一次实验中，本库会对每个运行（Run）自动完成以下步骤：

### 初始化（Initialize）

环境（Environment）会根据[参数]`env`初始化，包括加载数据：

1. 加载地形数据（DEM）
2. 加载坡度数据（SLO）
3. 加载限制狩猎采集者数量的栅格数据（LIM_H）

### 设置（Setup）

添加初始的三类主体：

1. **狩猎采集者（Hunter）**：根据[参数]`env.init_hunters`设置的比例或数量，在非水体格子中随机选择位置创建。每个狩猎采集者的初始人口根据 `Hunter.init_size` 参数随机取值。

2. **农民（Farmer）**：根据[参数]`env.init_farmers`设置的数量（默认80），在可耕地中随机选择位置创建。每个农民的初始人口根据 `Farmer.init_size`参数（默认60-100）随机取值。

3. **水稻农民（RiceFarmer）**：根据[参数]`env.init_rice_farmers`设置的数量（默认350），在水稻可耕地中随机选择位置创建。每个水稻农民的初始人口根据 `RiceFarmer.init_size` 参数（默认300-400）随机取值。

> [!important]
> **重要变更**：现在所有三类主体都在初始化时创建，不再需要等待特定的时间步。`tick_farmer` 和 `tick_ricefarmer` 参数默认为 0。

### 步骤（Step）

随着运行步数(tick)的增加，模型会不断重复以下步骤：

#### 环境步骤（Environment Step）

1. 根据[参数] `env.lam_farmer` 通过泊松分布添加新的[农民]（Farmer）
2. 根据[参数] `env.lam_ricefarmer` 通过泊松分布添加新的[水稻农民]（RiceFarmer）

#### 主体步骤（Agent Step）

依次**随机**选择所有主体，执行它们的 `step` 方法：

##### 所有主体的共同行为

1. **人口增长**：根据[参数] `<breed>.growth_rate` 设置的增长率更新种群数量
2. **转化**：根据[参数] `<breed>.convert_prob` 设置的概率尝试转化为其他类型主体
   - 需要满足转化条件（周围有目标类型、自身人口规模符合阈值等）
   - 受全局转化开关 `convert.enabled` 和具体转化开关（如 `convert.hunter_to_farmer`）控制
3. **扩散**：尝试分出新的群体到周围合适的位置
   - 农民和水稻农民：根据 `<breed>.diffuse_prob` 概率扩散
   - 狩猎采集者：当人口达到 `max_size` 时自动扩散
4. **损失**：所有主体都会以一定概率经历人口损失
   - 根据 `<breed>.loss.prob` 发生概率
   - 发生时人口减少 `<breed>.loss.rate` 比例

##### 狩猎采集者特有行为

- **移动**：未定居的狩猎采集者（人口 ≤ `is_complex`）会主动搜索并移动到更合适的位置
- **合并**：遇到其他狩猎采集者时会合并，合并后人口 = 两者之和（人口守恒）

#### 全局人口控制（Global Population Control）

在每个时间步结束时，模型会应用全局 Hunter 人口上限控制：

1. **计算当前总人口**：统计所有 Hunter 的总人口数
2. **检查上限**：如果总人口超过 `lim_h × 非水体栅格数量`，则进行随机减少
3. **随机减少**：随机选择 Hunter 并减少人口，直到总人口降到上限以下

> [!warning]
> **重要规则变更**：
> - ❌ **已删除竞争机制**：不同类型主体之间不再竞争
> - ✅ **每格唯一主体**：一个格子只能有一个主体（任何类型）
> - ✅ **人口守恒**：扩散和合并操作严格保证人口总数不变
> - ✅ **全局人口上限**：Hunter 人口有全局上限控制机制

#### 死亡检查

在每一步都会检查当前的种群数量是否低于人口规模阈值（由[参数] `<breed>.min_size` 决定），若低于则执行 `die` 方法，该群体消亡。

### 结束（End）

结束条件是当设置的运行步数达到[参数]`time.end`时，模型会保存以下数据供与其它运行对比分析：

1. 所有个体的信息，如种群数量、位置、状态等
2. 所有个体的信息，如种群数量、位置、状态等
3. 所有个体的信息，如种群数量、位置、状态等

<!-- Links -->
[实验流程]: #实验流程
[模型流程]: #模型流程
[参数]: ./config.md
[狩猎采集者]: ../api/hunter.md
[农民]: ../api/farmer.md#农民
[水稻农民]: ../api/farmer.md#水稻农民
