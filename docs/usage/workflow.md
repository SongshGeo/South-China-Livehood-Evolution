---
title: 模型工作流
author: Shuang Song
---

典型的多主体模型实验拥有下图所示的结构，左侧是[实验流程]，右侧是[模型流程]。

![workflow](https://songshgeo-picgo-1302043007.cos.ap-beijing.myqcloud.com/uPic/workflow.png)

## 实验流程

在每一次实验中，本库会自动完成以下步骤：

1. 获取不同参数的组合，确定实验配置组数（jobs）
2. 批量运行模型，每次运行(run)都保存运行的结果
3. 绘制所有job的对比结果图（[热力图]、[断点图]、[动态图]）
4. 存储[总结数据]（`summary.csv`）

## 模型流程

在每一次实验中，本库会对每个运行（Run）自动完成以下步骤：

### 初始化（Initialize）

环境（Environment）会根据[参数]`env`初始化，包括加载数据：

1. 加载地形数据（DEM）
2. 加载坡度数据（SLO）
3. 加载限制狩猎采集者数量的栅格数据（LIM_H）

### 设置（Setup）

添加初始的[狩猎采集者]（Hunter），根据[参数]`env.init_hunters`设置的比例，在可利用的格子中随机选择。

> [!example]
> 如果`env.init_hunters=0.05`，则会在可利用的格子中随机选择5%的格子（取整），并在所有被选中的格子里添加一个新生成的狩猎采集者，该狩猎采集者群体的初始大小根据[参数]`env.init_hunters_size`设置的上下限，按均匀分布随机取值。

### 步骤（Step）

随着运行步数(tick)的增加，模型会不断重复以下步骤：

1. 根据[参数]添加农民的期望（`env.lam_farmer`）添加新的普通[农民]（Farmer）
2. 根据[参数]添加水稻农民的期望（`env.lam_ricefarmer`）添加新的[水稻农民]（RiceFarmer）
3. 依次**随机**选择[狩猎采集者]、[农民]、[水稻农民]中的一个，执行它的`step`方法。对于三种主体，其`step`方法大同小异，均包含：
   1. **增长**：根据[参数]`<breed>.growth_rate`设置的增长率，在现有种群规模的基础上更新种群数量。
   2. **转化**：根据[参数]`<breed>.convert_prob`设置的转化概率，尝试转化为其他形式的主体。
   3. **扩散**：根据[参数]`<breed>.diffuse_prob`设置的扩散概率，尝试建立新的种群并扩散到周围[适宜存活]的格子，如果扩散到
4. 如果是[狩猎采集者]，则执行`move`方法，尝试在周围主动找到一个[适宜存活]的格子，并移动过去。如果移动
5. 如果是[农民]或[水稻农民]，还要执行`loss`方法，即以一定概率（如遭遇灾害）降低种群数量。

在每一步都会检查当前的种群数量是否低于人口规模阈值 (由[参数]`<breed>.min_size`决定)，若低于则执行`die`方法，种群数量直接清零，即人口规模不足以支撑该群体的延续。

### 结束（End）

结束条件是当设置的运行步数达到[参数]`time.end`时，模型会保存以下数据供与其它运行对比分析：

1. 所有个体的信息，如种群数量、位置、状态等
2. 所有个体的信息，如种群数量、位置、状态等
3. 所有个体的信息，如种群数量、位置、状态等

<!-- Links -->
[实验流程]: #实验流程
[模型流程]: #模型流程
[参数]: ./config.md
[狩猎采集者]: ../api/hunter.md
[农民]: ../api/farmer.md#农民
[水稻农民]: ../api/farmer.md#水稻农民
